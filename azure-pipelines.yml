trigger:
- develop

variables:
- group: OBS Pipeline
- name: azKey
  value: $(azk4y)
- name: vmUsername
  value: $(vm-user-name)
- name: vmIp
  value: $(vm-ip-address)
- name: gitlabRegistryUsername
  value: $(gitlab-registry-username)
- name: gitlabRegistryPassword
  value: $(gitlab-registry-password)

pool:
    vmImage: 'ubuntu-latest'

jobs:
- job: BuildAndPush
  displayName: 'Build and Push Docker Images'
  steps:
  - checkout: self
  - script: |
      echo "Logging in to GitLab Container Registry"
      echo "$(gitlabRegistryPassword)" | docker login --username $(gitlabRegistryUsername) --password-stdin registry.gitlab.com

      echo "Building and pushing Docker images"
      docker build -t registry.gitlab.com/nguyenlghe176558/cicd-be ./Backend/
      docker push registry.gitlab.com/nguyenlghe176558/cicd-be

      docker build -t registry.gitlab.com/nguyenlghe176558/cicd-fe ./Frontend/website
      docker push registry.gitlab.com/nguyenlghe176558/cicd-fe

      docker build -t registry.gitlab.com/nguyenlghe176558/cicd-admin ./Frontend/admin
      docker push registry.gitlab.com/nguyenlghe176558/cicd-admin
    displayName: 'Built and Pushed Docker Images'
## deploy
- job: DeployToAzureVM
  dependsOn: BuildAndPush
  displayName: 'Deploy to Azure VM'
  steps:
  - script: |
      ssh -i /home/$(vmUsername)/.ssh/$(azKey) $(vmUsername)@$(vmIp)
      
      sudo docker-compose -f online-book-shop-aws/docker-compose.yml down 

      cd /online-book-shop-aws

      git pull origin

      cd ..

      sudo docker-compose -f online-book-shop-aws/docker-compose.yml up -d
  displayName: 'Deployed to Azure VM'
