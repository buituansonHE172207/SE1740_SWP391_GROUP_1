trigger:
- develop

variables:
- group: OBS Pipeline
- name: vmUsername1
  value: $[variables.vmUsername]
- name: vmIp1
  value: $[variables.vmIp]
- name: feVmIp1
  value: $[variables.feVmIp]

pool:
    vmImage: 'ubuntu-latest'

jobs:
- job: Build
  displayName: 'Build Docker Images'
  steps:
  - task: DownloadSecureFile@1
    name: sshKey
    displayName: 'Get private key'
    inputs:
      secureFile: 'azk4y.pem'
  - script: |
      sudo chmod 400 $(sshKey.secureFilePath)
      ssh -o StrictHostKeyChecking=no -i $(sshKey.secureFilePath) $(vmUsername1)@$(vmIp1) "
      sudo docker start 30fb216fa855 &&
      cd online-book-shop-aws && 
      git pull origin develop && 
      cd .. &&
      sudo docker compose -f online-book-shop-aws/testDc.yml build 
      "
      ssh -o StrictHostKeyChecking=no -i $(sshKey.secureFilePath) $(vmUsername1)@$(feVmIp1) "
      cd online-book-shop-aws && 
      git pull origin develop && 
      cd .. &&
      sudo docker compose -f online-book-shop-aws/docker-compose.yml build 
      "

- job: Deploy
  displayName: 'Deploy Application'
  dependsOn: Build
  steps:
  - task: DownloadSecureFile@1
    name: sshKey
    displayName: 'Get private key'
    inputs:
      secureFile: 'azk4y.pem'
  - script: |
      sudo chmod 400 $(sshKey.secureFilePath)
      ssh -o StrictHostKeyChecking=no -i $(sshKey.secureFilePath) $(vmUsername1)@$(vmIp1) "
      sudo docker compose -f online-book-shop-aws/testDc.yml down
      "
      ssh -o StrictHostKeyChecking=no -i $(sshKey.secureFilePath) $(vmUsername1)@$(feVmIp1) "
      sudo docker compose -f online-book-shop-aws/docker-compose.yml down
      "
      ssh -o StrictHostKeyChecking=no -i $(sshKey.secureFilePath) $(vmUsername1)@$(vmIp1) "
      sudo docker compose -f online-book-shop-aws/testDc.yml up --force-recreate -d
      "
      ssh -o StrictHostKeyChecking=no -i $(sshKey.secureFilePath) $(vmUsername1)@$(feVmIp1) "
      sudo docker compose -f online-book-shop-aws/docker-compose.yml up --force-recreate -d
      "