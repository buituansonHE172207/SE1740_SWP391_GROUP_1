trigger:
- develop

pool:
  vmImage: 'ubuntu-latest'

jobs:
- job: BuildAndPushDockerImages
  steps:
  - script: |
      docker-compose -f docker-compose.yml -p myapp build
      docker-compose -f docker-compose.yml -p myapp push
    displayName: 'Build and Push Docker Images'
    env:
      DOCKER_BUILDKIT: 1

- job: DeployToAzureWebApp
  dependsOn: BuildAndPushDockerImages
  steps:
  - task: UsePythonVersion@0
    inputs:
      versionSpec: '3.x'
      addToPath: true
  - script: |
      az login --service-principal -u $(AZURE_SERVICE_PRINCIPAL_CLIENT_ID) -p $(AZURE_SERVICE_PRINCIPAL_CLIENT_SECRET) --tenant $(AZURE_SERVICE_PRINCIPAL_TENANT_ID)
      az container create --resource-group $(AZURE_RESOURCE_GROUP) --name myapp --image myregistry.azurecr.io/myapp:latest --ports 8081 3000 3001 --dns-name-label myapp --environment-variables DB_HOST=azuresqledge
    displayName: 'Deploy to Azure Container Instances'
    env:
      AZURE_SERVICE_PRINCIPAL_CLIENT_ID: $(AZURE_SERVICE_PRINCIPAL_CLIENT_ID)
      AZURE_SERVICE_PRINCIPAL_CLIENT_SECRET: $(AZURE_SERVICE_PRINCIPAL_CLIENT_SECRET)
      AZURE_SERVICE_PRINCIPAL_TENANT_ID: $(AZURE_SERVICE_PRINCIPAL_TENANT_ID)
      AZURE_RESOURCE_GROUP: 'SachTrucTuyen' 